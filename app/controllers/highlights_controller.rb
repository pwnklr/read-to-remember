class HighlightsController < ApplicationController
  before_action :set_highlight, only: [:edit, :update, :destroy, :fav, :unfav, :export]
  before_action :set_tag, only: :tags
  respond_to :html, :js

  # search here
  def index
    if params[:query].present?
      @query = params[:query]
      @highlights = current_user.highlights.includes(:source, :taggings,  source: :author).global_search(@query)
      @count = @highlights.size
    else
      @highlights = []
    end
  end

  def edit
  end

  def update
    if @highlight.update(note_tag_param)
      respond_to :js
    end
  end

  # atm => move to images cntrl
  def share
    require "base64"
    # enc => image.content
    # after_action, trigger share, after share destroy file
    enc = 'iVBORw0KGgoAAAANSUhEUgAAASkAAAEUCAYAAAB3fcDxAAAgAElEQVR4Xu2dCbxV0/v/n0rzQKNm0agiSppRkjSjSFKoRIYylcy++JqHROEbIiRKCkmzEpWUBhqVNGjQPM//13v9X/v+juOce+6tc+45d5/Per3uq+49Z6+91nut9dnP8+y9np3l+PHjx01FBERABBKUQBaJVIKOjJolAiLgCEikNBFEQAQSmoBEKqGHR40TARGQSGkOiIAIJDQBiVRCD48aJwIiIJHSHBABEUhoAhKphB4eNU4EREAipTkgAiKQ0AQkUgk9PGqcCIiAREpzQAREIKEJSKQSenjUOBEQAYmU5oAIiEBCE5BIJfTwqHEiIAISKc0BERCBhCYgkUro4VHjREAEJFKaAyIgAglNQCKV0MOjxomACEikNAdEQAQSmoBEKqGHR40TARGQSGkOiIAIJDQBiVRCD48aJwIiIJHSHBABEUhoAhKphB4eNU4EREAipTkgAiKQ0AQkUgk9PGqcCIiARCoB5sC4ceOsZcuW1rZtW/viiy9OuEU//PCDNWvWzCpUqGC//PLLCdcTzQO///57u+yyy6xGjRo2a9asNFX9+eefW79+/axAgQL29ddfW/HixdN0XHq/1KdPHxswYIANHjzYbr311vQeru9nEIEMEakXXnjBJkyYYEWKFLEVK1a4BfnEE09kUBfNDh8+bP3797eXXnrJTj31VLvkkkts+fLl7t8XX3zR8uTJk2FtCXeiLFmyRBQpFtW8efOsWLFibsGvX7/eLr/8csudO7fNnj3bFi5caOedd57jnF6RmjhxomP0888/W7169RynX3/91a688krHKHv27GEZbd++3YYNG2Z33XWX+07w77QH4UyrSPF9xubpp5+2kiVLWv78+dM9Pj/99JPddtttrj/XXnutPfPMM1a6dGl76qmnbOjQofbGG2/YKaecYldccYVEKt10M/aAmIsUi6VmzZq2c+dON9l27drlJjMTJSPLgQMH3GLmik6bvvzyS2vTpo317dvXnnvuuYxsSshzZc2a1bUnNUvq7rvvtieffNLy5ctn7dq1szFjxtiiRYusevXqdt9999kDDzzgRKpo0aI2f/78dPeJ42ExevRoVz8CRXumTZtmF198cdj6/vOf/9gHH3xgK1eudN8J/j09IoXAFSpUyLp162ZDhgxJ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GZk7VURABDIfgZiLFM81BWeW5OWX5JXmfXi85JFHFLgzxws5ealhYCGzIC9C/PDDD132yHDZJLG4yGjJCyERNu4KIlASqcw3KdViEQgkEHORSitu0qbwkknemccbbik8MsBLFrCISNehIgIikHwEEkakcPPI18xzUoGFO4Ck9iW/tYoIiEDyEUgYkeIJcd7WwRtAvIJVxZ0+3EPiUyoiIALJRyBhRIptK/fdd597e0yBAgXcW0Fw+5566ikXr1IRARFITgIJI1LJiV+9FgERiERAIhWJkD4XARGIKwGJVFzx6+QiIAKRCEikIhHS5yIgAnElIJGKK36dXAREIBIBiVQkQvpcBEQgrgQkUnHFr5OLgAhEIiCRikRIn4uACMSVgEQqrvh1chEQgUgEJFKRCOlzERCBuBKQSMUVv04uAiIQiYBEKhIhfS4CIhBXAhKpuOLXyUVABCIRkEhFIqTPRUAE4kpAIhVX/Dq5CIhAJAISqUiE9LkIiEBcCUik4opfJxcBEYhEQCIViZA+FwERiCsBiVRc8evkIiACkQjEXKSmTp1qgwYNspEjR1q1atXciz55pfpFF11kjz32mBUtWjRSG6P6Oe/mI496iRIlbPv27VarVi175plnXF51ypIlS+zee++17Nmz244dO6xq1ar28ssvW+7cud3nvBSCz3PlymVHjhyxQ4cOuc+rV6/uPicvO6/nCi4PPfSQy9euIgIikD4CMRcpmvPLL7/Y+eefb6NHj7Z27drZli1brGnTpm5BT5s2zXh9ekaVyy+/3L2ANGvWrE4szzvvPGvcuLG99dZb7uUPVapUsd69e9v9999vR48edWJK23mbDYVXbLVq1cpeeOEF9zsvj+AtNwgfhZeUPv744//oDq/k4hXyHKsiAiKQPgJxESmaOHjwYOvVq5etXr3aypUrl65WY8G88847TlwqVaqUrmN5ozIi4xXeoIy1xzv/sPY6dOhgW7dutUKFCrmvcB5eq7Vt2zYnbDly5LChQ4da165d3ee8WZl3AiJ4WFvDhw+36667LqX+lStXOstrzJgx6WqnviwCIvD/CcRNpDxB+PHHH61u3br24osv2vjx450bhkv1yCOPuDcaU9auXeuEIm/evLZp0yb3eYsWLWzIkCHu81WrVrlXtefJk8e99fjaa6+1O+64I01jzJuRFy1aZHPmzHFu2wMP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'
    plain = Base64.decode64(enc)
    directory_name = "public/my_images"
    Dir.mkdir(directory_name) unless File.exists?(directory_name)
    file_path = "#{directory_name}/image_to_remember_#{current_user.id}.png"
    File.open(file_path, "wb") do |file|
      file.write(plain)
    end
  end

  def destroy # works (except: carousel)
    @highlight.destroy
    # respond_to :js
    # flash[:notice] = 'Highlight was succsesfully removed!'
  end

  def fav # works!
    current_user.favorite(@highlight)
    #redirect_back(fallback_location: 'pages#home')
    # respond_to do |format|
    #   format.js
    # end
  end

  def unfav # works!
    current_user.unfavorite(@highlight)
    #redirect_back(fallback_location: 'pages#home')
    # respond_to do |format|
    #  format.js
    # end
  end

  def export # works!
    # generate file:
    directory_name = "public/data"
    Dir.mkdir(directory_name) unless File.exists?(directory_name)
    file_path = "#{directory_name}/read_to_remember_#{current_user.id}.md"
    File.open(file_path, "w+") do |file|
      file << "# #{@highlight.source.title}\n\n"
      file << "## #{@highlight.source.author.name}\n\n"
      file << "#{@highlight.content}\n\n"
      file << "page: #{@highlight.page}\n\n"
      if !@highlight.my_note.nil? && @highlight.my_note.match(/[^\s]/)
        file << "note: #{@highlight.my_note}"
      end
    end
    # destroy file
    sleep(2)
    File.open(file_path, "w+") { |file| file << "" }
  end

  def flashcards
    @flashcards = current_user.flashcards.includes(:taggings, source: :author)
  end

  def favorites
     @image = Image.new
    @highlights = current_user.highlights.includes(:taggings, source: :author).joins('INNER JOIN favorites on highlights.id = favorites.favoritable_id').order('favorites.created_at desc')
  end

  def tags
    @tagged_highlights = current_user.highlights.includes(:taggings, source: :author).tagged_with(["#{@tag}"], :any => true)
  end

  def all_tags
    if params[:select_t]
      if params[:select_t] == '2' # amount
        @all_tags = current_user.highlights.includes(:taggings, source: :author).tag_counts_on(:tags).order(taggings_count: :desc)
      else
        @all_tags = current_user.highlights.includes(:taggings, source: :author).tag_counts_on(:tags).order(created_at: :desc)
      end
    else
      @all_tags = current_user.highlights.includes(:taggings, source: :author).tag_counts_on(:tags).order(created_at: :desc)
    end
  end

  private

  def set_highlight
    @highlight = Highlight.find(params[:id])
  end

  def set_tag
    @tag = params[:format]
  end

  def highlight_params
    params.require(:highlight).permit(:content, :page, :favorite, :source_id, :user_id, :tag_list)
  end

  def note_tag_param
    params.require(:highlight).permit(:h_note, :my_note, :tag_list)
  end
end
